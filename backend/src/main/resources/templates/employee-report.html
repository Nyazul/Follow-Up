<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Employee Detail - FollowUps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/main.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <!-- Navbar -->
    <div th:replace="~{/navbar :: navbar('ADMIN', 'report')}"></div>

    <div class="content">
      <!-- Alerts -->
      <div
        th:if="*{message!=null and #strings.length(message)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-primary text-center fw-bolder"
        th:text="${message}"
      ></div>
      <div
        th:if="*{error!=null and #strings.length(error)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-danger text-center fw-bolder"
        th:text="${error}"
      ></div>

      <!-- Employee Info -->
      <div class="container bg-white rounded shadow p-4 mb-4">
        <h4 class="mb-4 text-primary fw-bolder text-center">Employee Detail</h4>
        <div class="row mb-3">
          <div class="col-md-4">
            <p>
              <strong>Name :</strong>
              <span th:text="${employeeReport.name}">Alice</span>
            </p>
          </div>
          <div class="col-md-4">
            <p>
              <strong>Email :</strong>
              <span th:text="${employeeReport.email}">alice@example.com</span>
            </p>
          </div>
          <div class="col-md-4">
            <p>
              <strong>Phone :</strong>
              <span th:text="${employeeReport.phoneNumber}">1234567890</span>
            </p>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4">
            <p>
              <strong>Department :</strong>
              <span th:text="${employeeReport.departmentName}">CS</span>
            </p>
          </div>
        </div>

        <script th:inline="javascript">
          let employeeReport = /*[[${employeeReport}]]*/ {};
        </script>

        <!-- Time Range Selector -->
        <div class="row mb-3">
          <div class="col-md-4">
            <label class="form-label">Select Time Range:</label>
            <select id="timeRange" class="form-select">
              <option value="week" selected>This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>

        <!-- Chart -->
        <div class="bg-white p-3 mt-3 rounded shadow-sm" >
          <canvas id="trendChart" height="100"></canvas>
        </div>
      </div>

      <!-- Toggle Button -->
      <div class="container text-center mb-4">
        <button id="loadFollowupsBtn" style="background-color: #203354; color: white;" class="btn">
          Load Follow-Ups
        </button>
      </div>

      <!-- Follow-Up List -->
      <div
        id="followupContainer"
        class="container bg-white rounded p-4 mb-5 d-none"
      >
        <h5 class="mb-3 text-primary fw-bolder text-center">Follow-Ups</h5>
        <div id="followupList"></div>
      </div>
    </div>

    <!-- Bootstrap & Chart Script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/main.js}"></script>

    <script>
      let followUpData = employeeReport.followUps.map((f) => ({
        date: f.dueDate,
      }));

      function groupData(data, range) {
        const result = {};
        const weekdayOrder = ["Mon", "Tue", "Wed", "Thu", "Fri"]; // exclude Sat & Sun
        const monthOrder = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const weeksInMonth = ["Week 1", "Week 2", "Week 3", "Week 4", "Week 5"];

        // Initialize result with zero values
        if (range === "week") {
          weekdayOrder.forEach((day) => (result[day] = 0));
        } else if (range === "month") {
          weeksInMonth.forEach((week) => (result[week] = 0));
        } else if (range === "year") {
          monthOrder.forEach((month) => (result[month] = 0));
        }

        // Count actual data
        data.forEach((entry) => {
          const date = new Date(entry.date);
          let key;

          switch (range) {
            case "week":
              const day = date.toLocaleDateString("en-US", {
                weekday: "short",
              });
              if (!weekdayOrder.includes(day)) return; // skip Sat & Sun
              key = day;
              break;
            case "month":
              key = `Week ${Math.ceil(date.getDate() / 7)}`;
              break;
            case "year":
              key = date.toLocaleDateString("en-US", { month: "short" });
              break;
          }

          if (result.hasOwnProperty(key)) {
            result[key]++;
          } else {
            result[key] = 1; // fallback (just in case)
          }
        });

        // Determine the correct order
        let orderedKeys;
        if (range === "week") orderedKeys = weekdayOrder;
        else if (range === "month") orderedKeys = weeksInMonth;
        else orderedKeys = monthOrder;

        // Build sorted result
        const sorted = {};
        orderedKeys.forEach((k) => (sorted[k] = result[k] || 0));
        return sorted;
      }

      function renderChart(range) {
        const grouped = groupData(followUpData, range);
        const labels = Object.keys(grouped);
        const values = Object.values(grouped);

        const ctx = document.getElementById("trendChart").getContext("2d");
        if (
          window.trendChart &&
          typeof window.trendChart.destroy === "function"
        ) {
          window.trendChart.destroy();
        }

        window.trendChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Completed Follow-Ups",
                data: values,
                borderColor: "#203354",
                backgroundColor: "rgba(18, 96, 160, 0.2)",
                fill: true,
                tension: 0.4,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "Count" },
              },
              x: {
                title: { display: true, text: "Time" },
              },
            },
          },
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        renderChart("week");
        document.getElementById("timeRange").addEventListener("change", (e) => {
          renderChart(e.target.value);
        });

        document
          .getElementById("loadFollowupsBtn")
          .addEventListener("click", async () => {
            const response = await fetch(
              `/api/employee/${employeeReport.id}/followups`
            ); // adjust endpoint as needed
            const followUps = await response.json();

            const container = document.getElementById("followupContainer");
            const list = document.getElementById("followupList");
            list.innerHTML = "";

            followUps.forEach((followUp) => {
              const div = document.createElement("div");
              div.onclick = () => {
                window.location.href = `/completed-followup/${followUp.id}`;
              };
              div.classList.add(
                "border-bottom",
                "pb-3",
                "mb-3",
                "container",
                "rounded",
                "shadow",
                "cursor-pointer",
                "hover-effect"
              );
              div.innerHTML = `
            <div class="row hover">
              <div class="col-md-4"><strong>Lead : </strong> ${
                followUp.leadName
              }</div>
              <div class="col-md-4"><strong>Date : </strong> ${new Date(
                followUp.dueDate
              ).toLocaleString()}</div>
            </div>
            <div class="row mt-2">
              <div class="col-md-4"><strong>Description : </strong> ${
                followUp.description
              }</div>
              <div class="col-md-4"><strong>Course : </strong> ${
                followUp.courseName
              }</div>
            </div>
          `;
              list.appendChild(div);
            });

            container.classList.remove("d-none");
          });
      });
    </script>
  </body>
</html>
