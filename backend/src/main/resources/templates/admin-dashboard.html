<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />
    <link rel="stylesheet" th:href="@{/main.css}" />
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div th:replace="~{/navbar :: navbar('ADMIN', 'dashboard')}"></div>

    <div class="content">
      <div
        th:if="*{message!=null and #strings.length(message)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-primary text-center fw-bolder"
        th:text="${message}"
      ></div>

      <div
        th:if="*{error!=null and #strings.length(error)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-danger text-center fw-bolder"
        th:text="${error}"
      ></div>

      <!-- Admin Dashboard Template (excluding sidebar and navbar) -->
      <div class="container-fluid mt-4">
        <!-- Time Range Selector -->
        <div class="row mb-3">
          <div class="col-md-4">
            <select id="timeRange" class="form-select">
              <option value="week" selected>This Week</option>
              <option value="month">This Month</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>
        <!-- Summary Chart -->
        <div class="bg-white p-4 rounded shadow-sm mb-5">
          <canvas id="summaryChart" height="100"></canvas>
        </div>

        <!-- Overview Cards -->
        <div class="row">
          <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary h-100">
              <div class="card-body">
                <h5 class="card-title">Total Employees</h5>
                <p class="card-text fs-4">[[${totalEmployees}]]</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-white bg-success h-100">
              <div class="card-body">
                <h5 class="card-title">Completed This Week</h5>
                <p class="card-text fs-4">[[${completedThisWeek}]]</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning h-100">
              <div class="card-body">
                <h5 class="card-title">Remaining Today</h5>
                <p class="card-text fs-4">[[${remainingToday}]]</p>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-3">
            <div class="card text-white bg-info h-100">
              <div class="card-body">
                <h5 class="card-title">Tasks Assigned</h5>
                <p class="card-text fs-4">[[${totalTasks}]]</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chart.js CDN -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      <script th:inline="javascript">
        function groupDataByRange(data, range) {
          const weekdayOrder = ["Mon", "Tue", "Wed", "Thu", "Fri"]; // Removed Sat, Sun
          const monthOrder = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          const result = {};

          // Initialize keys with 0
          switch (range) {
            case "week":
              weekdayOrder.forEach((day) => (result[day] = 0));
              break;
            case "month":
              for (let i = 1; i <= 5; i++) result[`Week ${i}`] = 0;
              break;
            case "year":
              monthOrder.forEach((month) => (result[month] = 0));
              break;
          }

          // Populate data
          data.forEach((entry) => {
            const date = new Date(entry.date);
            let key;

            switch (range) {
              case "week":
                const day = date.toLocaleDateString("en-US", {
                  weekday: "short",
                });
                if (!weekdayOrder.includes(day)) return; // Skip Sat & Sun
                key = day;
                break;
              case "month":
                key = `Week ${Math.ceil(date.getDate() / 7)}`;
                break;
              case "year":
                key = date.toLocaleDateString("en-US", { month: "short" });
                break;
            }

            if (result.hasOwnProperty(key)) {
              result[key] += entry.completed;
            } else {
              result[key] = entry.completed;
            }
          });

          // Ensure keys are ordered
          let sortedKeys;
          if (range === "week") sortedKeys = weekdayOrder;
          else if (range === "year") sortedKeys = monthOrder;
          else sortedKeys = [`Week 1`, `Week 2`, `Week 3`, `Week 4`, `Week 5`];

          const sortedResult = {};
          sortedKeys.forEach((k) => (sortedResult[k] = result[k] || 0));
          return sortedResult;
        }

        function renderChart(data, range) {
          const ctx = document.getElementById("summaryChart").getContext("2d");
          if (
            window.summaryChart &&
            typeof window.summaryChart.destroy === "function"
          ) {
            window.summaryChart.destroy();
          }
          const grouped = groupDataByRange(data, range);
          const labels = Object.keys(grouped);
          const values = Object.values(grouped);

          window.summaryChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: `Completed Follow-ups (${capitalize(range)})`,
                  data: values,
                  backgroundColor: "rgba(18, 96, 160, 0.5)",
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Number of Follow-ups" },
                },
                x: { title: { display: true, text: getXAxisLabel(range) } },
              },
            },
          });
        }

        function capitalize(text) {
          return text.charAt(0).toUpperCase() + text.slice(1);
        }
        function getXAxisLabel(range) {
          switch (range) {
            case "week":
              return "Day of Week";
            case "month":
              return "Week of Month";
            case "year":
              return "Month";
            default:
              return "Time";
          }
        }

        let followUpTrend = /*[[${followUpTrends}]]*/ [];
        document.addEventListener("DOMContentLoaded", () => {
          renderChart(
            followUpTrend,
            document.getElementById("timeRange").value
          );
          document
            .getElementById("timeRange")
            .addEventListener("change", (e) =>
              renderChart(followUpTrend, e.target.value)
            );
        });
      </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/main.js}"></script>
  </body>
</html>
