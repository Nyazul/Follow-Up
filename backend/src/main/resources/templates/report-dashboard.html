<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Follow-Up Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/main.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div th:replace="~{/navbar :: navbar('ADMIN', 'report')}"></div>

    <div
      th:if="${message != null}"
      class="alert alert-success mt-3"
      role="alert"
    >
      <span th:text="${message}"></span>
    </div>
    <div th:if="${error != null}" class="alert alert-danger mt-3" role="alert">
      <span th:text="${error}"></span>
    </div>

    <div class="content">

      <!-- Time Range Selector -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="timeRange" class="form-label">Select Time Range:</label>
          <select id="timeRange" class="form-select">
            <option value="week" selected>This Week</option>
            <option value="month">This Month</option>
            <option value="year">This Year</option>
          </select>
        </div>
      </div>

      <!-- Summary Chart -->
      <div class="bg-white p-4 rounded shadow-sm mb-5">
        <canvas id="summaryChart" height="100"></canvas>
      </div>

      <!-- Injecting data from model to JS -->
      <script th:inline="javascript">
        let departments = /*[[${departments}]]*/ [];
        let courses = /*[[${courses}]]*/ [];
        let employeeSummary = /*[[${employeeSummaries}]]*/ [];
        let followUpTrend = /*[[${followUpTrends}]]*/ [];
      </script>

      <!-- Filters for Employee List -->
      <div class="row mb-4 g-3">
        <div class="col-md-3">
          <select id="deptFilter" class="form-select">
            <option value="">All Departments</option>
            <option
              th:each="dept : ${departments}"
              th:value="${dept.id}"
              th:text="${dept.name}"
            ></option>
            <!-- <option value="IT">IT</option>
                         <option value="BBA">BBA</option> -->
          </select>
        </div>
        <div class="col-md-3">
          <select id="sortFilter" class="form-select">
            <option value="desc">Most Completed</option>
            <option value="asc">Least Completed</option>
          </select>
        </div>
      </div>

      <!-- Employee Cards -->
      <div id="employeeList" class="row row-cols-1 row-cols-md-2 g-4"></div>

      <script>
        function groupDataByRange(data, range) {
          const weekdayOrder = ["Mon", "Tue", "Wed", "Thu", "Fri"]; // Removed Sat, Sun
          const monthOrder = [
            "Jan",
            "Feb",
            "Mar",
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ];
          const result = {};

          // Initialize keys with 0
          switch (range) {
            case "week":
              weekdayOrder.forEach((day) => (result[day] = 0));
              break;
            case "month":
              for (let i = 1; i <= 5; i++) result[`Week ${i}`] = 0;
              break;
            case "year":
              monthOrder.forEach((month) => (result[month] = 0));
              break;
          }

          // Populate data
          data.forEach((entry) => {
            const date = new Date(entry.date);
            let key;

            switch (range) {
              case "week":
                const day = date.toLocaleDateString("en-US", {
                  weekday: "short",
                });
                if (!weekdayOrder.includes(day)) return; // Skip Sat & Sun
                key = day;
                break;
              case "month":
                key = `Week ${Math.ceil(date.getDate() / 7)}`;
                break;
              case "year":
                key = date.toLocaleDateString("en-US", { month: "short" });
                break;
            }

            if (result.hasOwnProperty(key)) {
              result[key] += entry.completed;
            } else {
              result[key] = entry.completed;
            }
          });

          // Ensure keys are ordered
          let sortedKeys;
          if (range === "week") sortedKeys = weekdayOrder;
          else if (range === "year") sortedKeys = monthOrder;
          else sortedKeys = [`Week 1`, `Week 2`, `Week 3`, `Week 4`, `Week 5`];

          const sortedResult = {};
          sortedKeys.forEach((k) => (sortedResult[k] = result[k] || 0));
          return sortedResult;
        }

        function renderChart(data, range) {
          const ctx = document.getElementById("summaryChart").getContext("2d");
          if (
            window.summaryChart &&
            typeof window.summaryChart.destroy === "function"
          ) {
            window.summaryChart.destroy();
          }
          const grouped = groupDataByRange(data, range);
          const labels = Object.keys(grouped);
          const values = Object.values(grouped);

          window.summaryChart = new Chart(ctx, {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: `Completed Follow-ups (${capitalize(range)})`,
                  data: values,
                  backgroundColor: "rgba(18, 96, 160, 0.5)",
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: "Number of Follow-ups" },
                },
                x: { title: { display: true, text: getXAxisLabel(range) } },
              },
            },
          });
        }

        function capitalize(text) {
          return text.charAt(0).toUpperCase() + text.slice(1);
        }
        function getXAxisLabel(range) {
          switch (range) {
            case "week":
              return "Day of Week";
            case "month":
              return "Week of Month";
            case "year":
              return "Month";
            default:
              return "Time";
          }
        }

        function renderEmployees(list) {
          const container = document.getElementById("employeeList");
          container.innerHTML = "";
          list.forEach((emp) => {
            container.innerHTML += `
            <div class="col">
                <div class="card shadow-sm h-100">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <h5 class="card-title">${emp.name}</h5>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Today:</strong> ${emp.completedToday}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9">
                            <p class="card-text">Dept: ${emp.department}</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>This Week:</strong> ${emp.completedWeek}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9">
                            <a href='/employee/${emp.id}/report' class="btn btn-sm btn-outline-dark">View Report</a>
                        </div>
                        <div class="col-md-3">
                            <p><strong>This Month:</strong> ${emp.completedMonth}</p>
                        </div>
                    </div>
                    
                </div>
                </div>
            </div>`;
          });
        }

        function applyFilters() {
          let list = [...employeeSummary]; // assuming employeeSummary is the original list
          const dept = document.getElementById("deptFilter").value;
          const sort = document.getElementById("sortFilter").value;
          if (dept) list = list.filter((e) => e.departmentId == dept);
          list.sort((a, b) =>
            sort === "asc"
              ? a.completedMonth - b.completedMonth
              : b.completedMonth - a.completedMonth
          );
          renderEmployees(list);
        }

        document.addEventListener("DOMContentLoaded", () => {
          renderChart(
            followUpTrend,
            document.getElementById("timeRange").value
          );
          renderEmployees(employeeSummary);
          document
            .getElementById("timeRange")
            .addEventListener("change", (e) =>
              renderChart(followUpTrend, e.target.value)
            );
          ["deptFilter", "sortFilter"].forEach((id) =>
            document.getElementById(id).addEventListener("change", applyFilters)
          );
        });
      </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/main.js}"></script>
  </body>
</html>
