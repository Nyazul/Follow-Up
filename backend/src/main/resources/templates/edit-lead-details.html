<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Edit Lead Details</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />
    <link rel="stylesheet" th:href="@{/main.css}" />
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div
      th:replace="~{/navbar :: navbar('FOLLOWUP_EMPLOYEE', 'remaining')}"
    ></div>

    <div class="content">
      <div
        th:if="*{message!=null and #strings.length(message)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-primary text-center fw-bolder"
        th:text="${message}"
      ></div>

      <div
        th:if="*{error!=null and #strings.length(error)>0}"
        class="mt-lg-5 mx-xxl-5 alert bg-danger text-center fw-bolder"
        th:text="${error}"
      ></div>

      <form
        class="form-section"
        th:action="@{/remaining-followup/{id}/edit-lead-details(id=${editLeadDetailsDTO.leadId})}"
        th:object="${editLeadDetailsDTO}"
        method="post"
      >
        <div class="container bg-white rounded shadow p-4 mb-1">
          <div class="row mb-3 align-items-center">
            <div class="col">
              <label class="form-label fw-bold">Name : </label>
              <input
                type="text"
                class="form-control"
                th:field="*{leadName}"
                th:classappend="${#fields.hasErrors('leadName')} ? 'is-invalid'"
                placeholder="Lead Name"
                th:value="*{leadName}"
                required
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('leadName')}"
                th:errors="*{leadName}"
              ></div>
            </div>
            <div class="col text-end">
              <input
                type="submit"
                value="Update ✅"
                class="btn btn-primary w-50 mb-2 fw-bolder"
              />
              <a
                class="btn btn-warning w-50"
                th:href="@{/remaining-followup/{id}(id=${editLeadDetailsDTO.followUpId})}"
                ><strong>Cancel</strong> ❌</a
              >
            </div>
          </div>

          <script th:inline="javascript">
            let departments = /*[[${departments}]]*/ [];
            let courses = /*[[${courses}]]*/ [];
          </script>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Department :</label>
              <select
                class="form-select"
                th:field="*{departmentId}"
                id="departmentSelect"
                th:classappend="${#fields.hasErrors('departmentId')} ? 'is-invalid'"
                required
              >
                <option value="" selected disabled>Select Department</option>
                <option
                  th:each="dept : ${departments}"
                  th:value="${dept.id}"
                  th:text="${dept.name}"
                ></option>
              </select>
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('departmentId')}"
                th:errors="*{departmentId}"
              ></div>
            </div>

            <div class="col-md-4">
              <label class="form-label fw-bold">Course :</label>
              <select
                class="form-select"
                th:field="*{courseCode}"
                id="courseSelect"
                th:classappend="${#fields.hasErrors('courseCode')} ? 'is-invalid'"
                required
              >
                <option value="" selected disabled>Select Course</option>
              </select>
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('courseCode')}"
                th:errors="*{courseCode}"
              ></div>
            </div>
          </div>

          <script>
            document.addEventListener("DOMContentLoaded", function () {
              const departmentSelect =
                document.getElementById("departmentSelect");
              const courseSelect = document.getElementById("courseSelect");

              // Update courses when department changes
              departmentSelect.addEventListener("change", function () {
                const selectedDeptId = parseInt(this.value);
                const filteredCourses = courses.filter(
                  (course) => course.departmentId === selectedDeptId
                );

                courseSelect.innerHTML =
                  '<option value="" disabled>Select Course</option>';
                filteredCourses.forEach((course) => {
                  const opt = document.createElement("option");
                  opt.value = course.code;
                  opt.textContent = course.name;
                  if (
                    parseInt(opt.value) ===
                    parseInt(/*[[${editLeadDetailsDTO.courseCode}]]*/ 0)
                  ) {
                    opt.selected = true; // preselect if matched
                  }
                  courseSelect.appendChild(opt);
                });
              });

              // Trigger it once on load to populate if editing
              if (departmentSelect.value) {
                departmentSelect.dispatchEvent(new Event("change"));
              }
            });
          </script>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label fw-bold">Mobile :</label>
              <input
                type="tel"
                class="form-control"
                th:field="*{mobile}"
                th:value="*{mobile}"
                placeholder="ex: 8551055201"
                th:classappend="${#fields.hasErrors('mobile')} ? 'is-invalid'"
                required
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('mobile')}"
                th:errors="*{mobile}"
              ></div>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Email :</label>
              <input
                type="email"
                class="form-control"
                th:field="*{email}"
                th:value="*{email}"
                placeholder="abc@xyz.com"
                th:classappend="${#fields.hasErrors('email')} ? 'is-invalid'"
                required
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('email')}"
                th:errors="*{email}"
              ></div>
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Address :</label>
              <input
                type="text"
                class="form-control"
                th:field="*{address}"
                th:value="*{address}"
                placeholder="area, city, state"
                th:classappend="${#fields.hasErrors('address')} ? 'is-invalid'"
                required
              />
              <div
                class="invalid-feedback"
                th:if="${#fields.hasErrors('address')}"
                th:errors="*{address}"
              ></div>
            </div>
          </div>
        </div>
      </form>

      <!-- Timeline -->
      <div
        class="timeline-container mt-2 p-3 rounded container bg-white shadow mb-5"
      >
        <div class="timeline-line">
          <div
            class="timeline-entry d-flex"
            th:each="node : ${editLeadDetailsDTO.nodes}"
          >
            <div class="timeline-date-box">
              <span th:text="${#temporals.format(node.date, 'dd')}">date</span>
              <br />
              <span th:text="${#temporals.format(node.date, 'MMM')}"
                >month</span
              >
            </div>
            <div class="d-flex">
              <strong class="text-primary" th:text="${node.title}">Title</strong
              ><strong>&nbsp;&nbsp; : &nbsp;&nbsp;</strong>
              <p th:text="${node.body}">Description</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/main.js}"></script>
  </body>
</html>
