<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Master AssignTask</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" th:href="@{/main.css}" />
  </head>

  <body class="bg-light p-4">
    <div th:replace="~{/navbar :: navbar('ADMIN', 'assign-task')}"></div>

    <div class="content">

      <div th:if="${message != null}" class="alert alert-success mt-3" role="alert">
        <span th:text="${message}"></span>
      </div>
      <div th:if="${error != null}" class="alert alert-danger mt-3" role="alert">
        <span th:text="${error}"></span>
      </div>

      <form id="taskForm" class="space-y-4" th:action="@{/task/assign}" th:method="post">
        <div class="container bg-white rounded shadow p-4 mb-4">
          <h2 class="text-2xl font-semibold mb-4 text-primary">Add New Task</h2>
          <div>
            <label for="title" class="block text-sm font-medium text-gray-700"
              >Title</label
            >
            <input
              type="text"
              id="title"
              name="title"
              required
              class="form-control mt-1"
            />
          </div>

          <div>
            <label for="body" class="block text-sm font-medium text-gray-700"
              >Body</label
            >
            <textarea
              id="body"
              name="body"
              required
              rows="3"
              class="form-control mt-1"
            ></textarea>
          </div>

          <div>
            <label for="dueDate" class="block text-sm font-medium text-gray-700"
              >Due Date</label
            >
            <input
              type="date"
              id="dueDate"
              name="dueDate"
              required
              class="form-control mt-1"
            />
          </div>

          <button
            type="submit"
            style="background-color: #203354; color: white;"
            class="text-white px-6 py-2 rounded-lg mt-3"
          >
            Add Task
          </button>
        </div>

        <!-- Employee List - placed directly below -->

        <h2 class="text-2xl font-semibold mb-4 text-primary">Employee to Assign</h2>
        <!-- Injecting data from model to JS -->
        <script th:inline="javascript">
          let departments = /*[[${departments}]]*/ [];
          let employeeSummary = /*[[${employeeSummaries}]]*/ [];
        </script>

        <!-- Filters for Employee List -->
        <div class="row mb-4 g-3">
          <div class="col-md-3">
            <select id="deptFilter" class="form-select">
              <option value="">All Departments</option>
              <option
                th:each="dept : ${departments}"
                th:value="${dept.id}"
                th:text="${dept.name}"
              ></option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="sortFilter" class="form-select">
              <option value="desc">Most Completed</option>
              <option value="asc">Least Completed</option>
            </select>
          </div>
          <div class="col-md-4">
            <input
              type="text"
              id="searchInput"
              class="form-control"
              placeholder="Search by employee name..."
            />
          </div>
        </div>

        <!-- Employee Cards -->
        <div
          id="employeeList"
          class="row row-cols-1 row-cols-md-2 g-4"
          required
        ></div>
        <input type="hidden" name="employeeId" id="employeeId" />

        <script>
          function renderEmployees(list) {
            const container = document.getElementById("employeeList");
            container.innerHTML = "";
            list.forEach((emp) => {
              container.innerHTML += `
      <div class="col">
        <div class="card shadow-sm h-100 employee-card" data-id="${emp.id}">
          <div class="card-body">
            <div class="row">
              <div class="col-md-9">
                <h5 class="card-title">${emp.name}</h5>
              </div>
              <div class="col-md-3">
                <p><strong>Today:</strong> ${emp.completedToday}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-9">
                <p class="card-text">Dept: ${emp.department}</p>
              </div>
              <div class="col-md-3">
                <p><strong>This Week:</strong> ${emp.completedWeek}</p>
              </div>
            </div>
            <div class="row">
              <div class="col-md-9">
              </div>
              <div class="col-md-3">
                <p><strong>This Month:</strong> ${emp.completedMonth}</p>
              </div>
            </div>
          </div>
        </div>
      </div>`;
            });

            // After rendering cards, add click listener
            document.querySelectorAll(".employee-card").forEach((card) => {
              card.addEventListener("click", () => {
                // Remove 'selected' class from all
                document
                  .querySelectorAll(".employee-card")
                  .forEach((c) => c.classList.remove("selected"));

                // Add 'selected' class to clicked one
                card.classList.add("selected");

                // Set hidden input value
                document.getElementById("employeeId").value =
                  card.getAttribute("data-id");
              });
            });
          }

          function applyFilters() {
            let list = [...employeeSummary];
            const dept = document.getElementById("deptFilter").value;
            const sort = document.getElementById("sortFilter").value;
            const search = document
              .getElementById("searchInput")
              .value.toLowerCase();

            if (dept) list = list.filter((e) => e.departmentId == dept);
            if (search)
              list = list.filter((e) => e.name.toLowerCase().includes(search));

            list.sort((a, b) =>
              sort === "asc"
                ? a.completedMonth - b.completedMonth
                : b.completedMonth - a.completedMonth
            );

            renderEmployees(list);
          }

          document.addEventListener("DOMContentLoaded", () => {
            renderEmployees(employeeSummary);
            ["deptFilter", "sortFilter", "searchInput"].forEach((id) =>
              document
                .getElementById(id)
                .addEventListener("input", applyFilters)
            );
            document
              .getElementById("taskForm")
              .addEventListener("submit", function (e) {
                const selectedEmployeeId =
                  document.getElementById("employeeId").value;
                if (!selectedEmployeeId) {
                  e.preventDefault(); // Stop form from submitting
                  alert("Please select an employee to assign the task.");
                  return false;
                }
              });
            // Set min date to today
            const dueDateInput = document.getElementById("dueDate");
            const today = new Date().toISOString().split("T")[0];
            dueDateInput.setAttribute("min", today);
          });
        </script>
      </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/main.js}"></script>
  </body>
</html>
